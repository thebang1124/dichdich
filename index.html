<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Dịch Tiếng Êđê - Việt</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base font for the body */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Loader spinner styles */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
        }
        /* Keyframe animation for the loader */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Dark mode specific styles */
        .dark .bg-gray-50 { background-color: #1a202c; }
        .dark .bg-white { background-color: #2d3748; }
        .dark .text-gray-800 { color: #f7fafc; }
        .dark .text-gray-600 { color: #cbd5e0; }
        .dark .text-gray-700 { color: #e2e8f0; }
        .dark .border-gray-200 { border-color: #4a5568; }
        .dark .bg-gray-50 { background-color: #4a5568; }
        .dark .border-gray-300 { border-color: #6b7280; }
        .dark .placeholder-gray-400::placeholder { color: #a0aec0; }
        .dark .bg-indigo-50 { background-color: #4338ca; } /* Darker indigo for dark mode */
        .dark .border-indigo-200 { border-color: #6366f1; }
        .dark .text-indigo-800 { color: #e0e7ff; }
        .dark .bg-purple-50 { background-color: #7c3aed; } /* Darker purple for dark mode */
        .dark .border-purple-200 { border-color: #a78bfa; }
        .dark .text-purple-800 { color: #ede9fe; }
        .dark .bg-blue-50 { background-color: #2563eb; } /* Darker blue for dark mode */
        .dark .border-blue-200 { border-color: #60a5fa; }
        .dark .text-blue-700 { color: #bfdbfe; }
        .dark .text-indigo-600 { color: #818cf8; }
        .dark .text-purple-600 { color: #c084fc; }
        .dark .text-gray-500 { color: #a0aec0; }
        .dark .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15); }
        .dark .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
        .dark .bg-indigo-600 { background-color: #4f46e5; }
        .dark .hover\:bg-indigo-700:hover { background-color: #4338ca; }
        .dark .bg-purple-600 { background-color: #9333ea; }
        .dark .hover\:bg-purple-700:hover { background-color: #7e22ce; }
        .dark .bg-gray-400 { background-color: #6b7280; }
        .dark .bg-gray-600 { background-color: #1a202c; }
        .dark .bg-gray-700 { background-color: #2d3748; }
        .dark .text-white { color: #f7fafc; }
        .dark .border-b-indigo-500 { border-color: #6366f1; }
        .dark .border-b-gray-300 { border-color: #4a5568; }
        .dark .text-gray-400 { color: #a0aec0; }
    </style>
</head>
<body class="bg-gray-50 transition-colors duration-300">
    <div id="root"></div>

    <!-- React CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs -->
    <script type="module">
        // Import necessary Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDocs, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Expose Firebase objects globally for the Babel script to access
        window.firebase = {
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut,
            getFirestore, collection, doc, addDoc, getDocs, onSnapshot, query, serverTimestamp
        };
    </script>

    <!-- React App Code -->
    <script type="text/babel">
        // Destructure React hooks for easier use
        const { useState, useEffect, useMemo, useRef } = React;

        // MessageModal Component for displaying messages to the user (instead of alert())
        const MessageModal = ({ message, onClose }) => {
            if (!message) return null; // Don't render if no message
            return (
                <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4 dark:bg-gray-700 dark:text-white">
                        <p className="text-lg font-semibold text-gray-800 mb-4 dark:text-white">{message}</p>
                        <button
                            onClick={onClose}
                            className="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition-colors"
                        >
                            Đóng
                        </button>
                    </div>
                </div>
            );
        };

        // Main App Component
        function App() {
            // State for dark mode toggle
            const [darkMode, setDarkMode] = useState(false);
            // State to manage active tab in the UI
            const [activeTab, setActiveTab] = useState('translate'); // Default tab is 'translate'
            // State for displaying modal messages
            const [message, setMessage] = useState('');

            // Firebase States for database, authentication, and user info
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [authLoading, setAuthLoading] = useState(true); // To show loading state during Firebase init

            // Translation States
            const [edeWord, setEdeWord] = useState(''); // Input for translation
            const [vietnameseMeaning, setVietnameseMeaning] = useState(''); // Output of translation
            const [isLoadingTextTranslate, setIsLoadingTextTranslate] = useState(false); // Loading indicator for text translation
            const [showGenerateExampleButton, setShowGenerateExampleButton] = useState(false); // To show/hide example generation button
            const [exampleSentence, setExampleSentence] = useState(''); // Example sentence output
            const [isLoadingExample, setIsLoadingExample] = useState(false); // Loading indicator for example generation
            const [translationDirection, setTranslationDirection] = useState('edeToViet'); // 'edeToViet' or 'vietToEde'

            // Image Translation States
            const [imageSrc, setImageSrc] = useState(null); // Base64 string of the uploaded image
            const [imageFile, setImageFile] = useState(null); // File object to get MIME type
            const [extractedText, setExtractedText] = useState(''); // Text extracted from image
            const [imageTranslation, setImageTranslation] = useState(''); // Translation of extracted text
            const [isLoadingImageTranslate, setIsLoadingImageTranslate] = useState(false); // Loading indicator for image translation

            // Paragraph Generation States
            const [paragraphPrompt, setParagraphPrompt] = useState(''); // User's prompt for paragraph
            const [generatedParagraph, setGeneratedParagraph] = useState(''); // Generated paragraph
            const [isLoadingParagraph, setIsLoadingParagraph] = useState(false); // Loading indicator for paragraph generation

            // Explanation States
            const [explanationWord, setExplanationWord] = useState(''); // Word/concept to explain
            const [generatedExplanation, setGeneratedExplanation] = useState(''); // Generated explanation
            const [isLoadingExplanation, setIsLoadingExplanation] = useState(false); // Loading indicator for explanation generation

            // Speech-to-Text States
            const [speechRecognitionText, setSpeechRecognitionText] = useState(''); // Recognized text from speech
            const [isRecording, setIsRecording] = useState(false); // Recording status
            const recognitionRef = useRef(null); // Ref for SpeechRecognition object

            // Text-to-Speech States
            const [speechSynthesisText, setSpeechSynthesisText] = useState(''); // Text to be spoken
            const [isSpeaking, setIsSpeaking] = useState(false); // Speaking status
            const [voices, setVoices] = useState([]); // Available voices for TTS
            const [selectedVoice, setSelectedVoice] = useState(null); // Currently selected voice
            const synthRef = useRef(null); // Ref for SpeechSynthesis object

            // History States
            const [historyItems, setHistoryItems] = useState([]); // List of historical interactions
            const historyUnsubscribeRef = useRef(null); // Ref to unsubscribe from Firestore listener

            // Dictionary Data (internal, hardcoded for demonstration)
            // This data is used for direct dictionary lookups before resorting to AI translation.
            // Examples are included where available.
            const dictionaryData = useMemo(() => [
                { ede: "Abao", type: "dt", vietnamese: "Ốc bươu", examples: [] },
                { ede: "Abăn", type: "dt", vietnamese: "Cái chăn (mền)", examples: ["Msăm abăn: Đắp chăn", "Abăn hmlei: Chăn bông"] },
                { ede: "Abŭ", type: "dt", vietnamese: "Cái hũ", examples: [] },
                { ede: "Adei", type: "dt", vietnamese: "Em", examples: [] },
                { ede: "Adě", type: "dt", vietnamese: "Hến", examples: [] },
                { ede: "Adham", type: "dt", vietnamese: "Một nhóm trong tộc người Êđê", examples: [] },
                { ede: "Adhan", type: "dt", vietnamese: "Cành", examples: ["Adhan kyão: Cành cây"] },
                { ede: "Adhei", type: "dt", vietnamese: "Trán", examples: ["Adhei bai: Trán rộng"] },
                { ede: "Adiê", type: "dt", vietnamese: "Trời", examples: ["Adiê hjan: Trời mưa"] },
                { ede: "Adiê không", type: "", vietnamese: "Nắng hạn", examples: [] },
                { ede: "Adiê tlam", type: "", vietnamese: "Xế chiều", examples: [] },
                { ede: "Adih", type: "đt", vietnamese: "Kia", examples: ["Sang kâo ti anôk adih: Nhà tôi chỗ kia", "Hruê aguah adih kâo đuễ hiu: Sáng ngày kia tôi đi chơi"] },
                { ede: "Adôk", type: "đgt", vietnamese: "Còn", examples: ["Kâo adôk prăk: Tôi còn tiền", "Adôk hdĩp: Còn sống"] },
                { ede: "Adrăng", type: "dt", vietnamese: "Rơm rạ", examples: ["Mkăm adrăng: Đống rơm"] },
                { ede: "Adring", type: "dt", vietnamese: "Hiên nhà sàn", examples: ["Amĩ kâo bhu mdiê ti adring: Mẹ tôi phơi lúa ở hiên nhà sàn"] },
                { ede: "Adrŏk", type: "dt", vietnamese: "Con cóc", examples: [] },
                { ede: "Aduôn", type: "dt", vietnamese: "Bà (nội, ngoại)", examples: [] },
                { ede: "Adŭ", type: "dt", vietnamese: "1.Phòng. Adŭ pit: Phòng ngủ; Adŭ hriăm: Phòng học. 2. Lớp. Adŭ năm: Lớp 6; Adŭ pluh dua: Lớp 12. 3. Cái ô. Adŭ jũ: Ô màu đen", examples: [] }, // Kept as is, as these are distinct meanings.
                { ede: "Adŭ bruă", type: "dt", vietnamese: "Văn phòng", examples: [] },
                { ede: "Adŭ git gai bruă kiă kriê", type: "dt", vietnamese: "Phòng hành chính", examples: [] },
                { ede: "Adŭ tĭng yap", type: "dt", vietnamese: "Phòng kế toán", examples: [] },
                { ede: "Adŭng", type: "dt", vietnamese: "Mũi", examples: ["Băng adũng: Lỗ mũi"] },
                { ede: "Aê", type: "dt", vietnamese: "Ông (nội, ngoại)", examples: [] },
                { ede: "Aê êa drao", type: "dt", vietnamese: "Bác sĩ", examples: [] },
                { ede: "Aguah", type: "trạng từ", vietnamese: "Buổi sáng", examples: ["Aguah ưm: Sáng sớm", "Aguah mgi: Sáng mai", "Aguah mbruê: Sáng hôm qua"] },
                { ede: "Ai", type: "dt", vietnamese: "Sức", examples: ["Ai ktang: Sức mạnh"] },
                { ede: "Ajĭk", type: "dt", vietnamese: "Ếch", examples: [] },
                { ede: "Ak", type: "dt", vietnamese: "Con quạ", examples: ["Jũ msě si ak: Đen như quạ"] },
                { ede: "Akăt", type: "dt", vietnamese: "Bụi (khóm)", examples: ["Akăt kram: Bụi tre"] },
                { ede: "Akâo", type: "đgt", vietnamese: "Xin", examples: ["Akâo prăk: Xin tiền", "Akâo êa mnăm: Xin nước uống"] },
                { ede: "Ala", type: "dt", vietnamese: "Con rắn", examples: ["Ala knăl: Rắn giun", "Ala mtah: Rắn lục"] },
                { ede: "Alah", type: "tt", vietnamese: "Lười biếng", examples: ["Alah mă bruă: Lười làm việc"] },
                { ede: "Ală", type: "dt", vietnamese: "Mắt", examples: ["Pĩt ală: Nhắm mắt"] },
                { ede: "Ama", type: "dt", vietnamese: "Bố (cha)", examples: [] },
                { ede: "Amai", type: "dt", vietnamese: "Chị", examples: [] },
                { ede: "Amâo", type: "pht", vietnamese: "Không", examples: ["Amâo mâo: Không có"] },
                { ede: "Amĭ", type: "dt", vietnamese: "Mẹ (má)", examples: [] },
                { ede: "Ana", type: "dt", vietnamese: "Cây. (tt): Giống cái (động vật). Ɇmô ana: Bò cái", examples: ["Hlăm hma, awa pla lu ana boh kroh. - Trong rẫy, bác trồng nhiều loại cây ăn trái.", "Ɇmô ana sang aê mrâo mdai. - Bò cái nhà ông mới đẻ."] },
                { ede: "Anak", type: "dt", vietnamese: "Con (người)", examples: [] },
                { ede: "Anăn", type: "dt", vietnamese: "Tên. (đt): Đó, đấy", examples: [] },
                { ede: "Anei", type: "đt", vietnamese: "Đây", examples: ["Kâo mă bruă ti anei: Tôi làm việc ở đây"] },
                { ede: "Anôk", type: "dt", vietnamese: "Nơi, chỗ, vị trí", examples: ["Djõ anôk: Đúng vị trí"] },
                { ede: "Ao", type: "dt", vietnamese: "Áo", examples: ["Ao kỗ: Áo trắng", "Ao hjan: Áo mưa"] },
                { ede: "Arăng", type: "đt", vietnamese: "Người ta", examples: ["Kâo dlăng arăng bị lông đi čữ. - Tôi xem người ta thi leo núi."] },
                { ede: "Asăr", type: "dt", vietnamese: "Hạt, hột. Asăr mdiê: Hạt lúa", examples: ["Boh čên anei lu asăr. - Quả chanh này nhiều hột.", "Mdiê bi asăr êdi. - Lúa rất chắc hạt."] },
                { ede: "Asâo", type: "dt", vietnamese: "Con chó", examples: [] },
                { ede: "Awa", type: "dt", vietnamese: "Bác (anh, chị của bố)", examples: [] },
                { ede: "Ayong", type: "dt", vietnamese: "Anh", examples: [] },
                
                // Bổ sung từ mới
                { ede: "Băng", type: "đgt", vietnamese: "Ăn (thức ăn nói chung), cháy, bén", examples: [] },
                { ede: "Blei", type: "đgt", vietnamese: "Mua", examples: ["Amai blei dua aruăt klei mah. - Chị mua hai sợi dây chuyền vàng."] },
                { ede: "Blŭ", type: "đgt", vietnamese: "Nói", examples: [] },
                { ede: "Boh", type: "dt", vietnamese: "Quả, trái, trứng; (đgt) giặt; (tl) cái, chiếc", examples: ["Boh suai: quả xoài;", "Boh mnũ: trứng gà.", "Boh chum ao: giặt quần áo.", "Dua boh kčok: hai cái ly;"] },
                { ede: "Bruă", type: "dt", vietnamese: "Việc, công việc. Mă bruă: làm việc", examples: ["Tơ nao mă bruă, kâo khăng đi êdeh pơ phút. - Khi đi làm, tôi thường đi xe máy."] },
                { ede: "Buôn", type: "dt", vietnamese: "Làng, buôn", examples: ["Hlăm buôn anei, mão lu boh gõ esei kjăp băng huă. - Trong buôn này, có nhiều con trâu ăn khỏe."] },
                { ede: "Čih", type: "đgt", vietnamese: "Viết", examples: [] },
                { ede: "Dlăng", type: "đgt", vietnamese: "Đọc, xem, nhìn", examples: [] },
                { ede: "Djam", type: "dt", vietnamese: "Rau, canh", examples: [] },
                { ede: "Djă", type: "đgt", vietnamese: "Cầm, giữ", examples: [] },
                { ede: "Drei", type: "đt", vietnamese: "Chúng ta, ta; (tl) con (dùng đếm con vật)", examples: [] },
                { ede: "êa", type: "dt", vietnamese: "Nước", examples: [] },
                { ede: "êdeh", type: "dt", vietnamese: "Xe", examples: ["Tơ nao mă bruă, kâo khăng đi êdeh pơ phút. - Khi đi làm, tôi thường đi xe máy."] },
                { ede: "êmô", type: "dt", vietnamese: "Con bò", examples: [] },
                { ede: "êsei", type: "dt", vietnamese: "Cơm", examples: [] },
                { ede: "Hriăm", type: "đgt", vietnamese: "Học", examples: [] },
                { ede: "Hruê", type: "dt", vietnamese: "Ngày", examples: ["Hruê mdei, kâo hiu chưn hồng bằng gặp. - Ngày nghỉ, tôi đi chơi với bạn."] },
                { ede: "Huă", type: "đgt", vietnamese: "Ăn (cơm)", examples: [] },
                { ede: "Ih", type: "đt", vietnamese: "Anh, chị, bạn (ngôi thứ 2 số ít)", examples: [] },
                { ede: "Jăk", type: "tt", vietnamese: "Tốt, ngon", examples: [] },
                { ede: "Kâo", type: "đt", vietnamese: "Tôi (ngôi thứ nhất số ít)", examples: ["Kâo dlăng arăng bị lông đi čữ. - Tôi xem người ta thi leo núi."] },
                { ede: "Kan", type: "dt", vietnamese: "Cá", examples: [] },
                { ede: "Khăp", type: "đgt", vietnamese: "Thích, yêu", examples: [] },
                { ede: "Klei", type: "dt", vietnamese: "Tiếng, lời, sự việc, dây", examples: ["Amai blei dua aruăt klei mah. - Chị mua hai sợi dây chuyền vàng."] },
                { ede: "Kphê", type: "dt", vietnamese: "Cà phê", examples: ["Čar Dak Lak pla lu kphê. - Tỉnh Đắk Lắk trồng nhiều cà phê."] },
                { ede: "Kyâo", type: "dt", vietnamese: "Gỗ, cây", examples: ["Sang kâo ngã hõng kyâo. - Nhà tôi làm bằng gỗ."] },
                { ede: "Mă", type: "đgt", vietnamese: "Làm, lấy, bắt", examples: [] },
                { ede: "Mâo", type: "đgt", vietnamese: "Có, được", examples: [] },
                { ede: "Mdiê", type: "dt", vietnamese: "Lúa", examples: [] },
                { ede: "Mlan", type: "dt", vietnamese: "Tháng, trăng", examples: [] },
                { ede: "Mnăm", type: "đgt", vietnamese: "Uống", examples: [] },
                { ede: "Mniê", type: "dt", vietnamese: "Phụ nữ, con gái", examples: [] },
                { ede: "Mnuih", type: "dt", vietnamese: "Người", examples: [] },
                { ede: "Mnŭ", type: "dt", vietnamese: "Con gà", examples: [] },
                { ede: "Nao", type: "đgt", vietnamese: "Đi", examples: [] },
                { ede: "Ñu", type: "đt", vietnamese: "Nó, ông ấy, bà ấy (ngôi thứ 3 số ít)", examples: [] },
                { ede: "Pla", type: "đgt", vietnamese: "Trồng, cấy", examples: [] },
                { ede: "Prăk", type: "dt", vietnamese: "Tiền, bạc", examples: [] },
                { ede: "Ruă", type: "đgt", vietnamese: "Đau, ốm", examples: ["Amũ kâo ruă aruăt ariêng. - Mẹ tôi đau gân cốt."] },
                { ede: "Sang", type: "dt", vietnamese: "Nhà", examples: ["Sang kâo ngã hõng kyâo. - Nhà tôi làm bằng gỗ."] },
                { ede: "Siam", type: "tt", vietnamese: "Đẹp", examples: [] },
                { ede: "Thâo", type: "đgt", vietnamese: "Biết", examples: [] },
                { ede: "Thuôn", type: "dt", vietnamese: "Năm, tuổi", examples: [] },
                { ede: "Ʉn", type: "dt", vietnamese: "Lợn, heo", examples: [] },
                { ede: "Aruăt", type: "dt", vietnamese: "Gân, sợi", examples: ["Amũ kâo ruă aruăt ariêng. - Mẹ tôi đau gân cốt.", "Amai blei dua aruăt klei mah. - Chị mua hai sợi dây chuyền vàng."] },
                { ede: "Čar", type: "dt", vietnamese: "Tỉnh, chẻ", examples: ["Čar Dak Lak pla lu kphê. - Tỉnh Đắk Lắk trồng nhiều cà phê.", "Aê dôk čar mnũng. - Ông đang chẻ lạt."] },
                { ede: "Đĭ", type: "đgt", vietnamese: "Leo, trèo, cưỡi, đi", examples: ["Kâo dlăng arăng bị lông đi čữ. - Tôi xem người ta thi leo núi.", "Tơ nao mă bruă, kâo khăng đi êdeh pơ phút. - Khi đi làm, tôi thường đi xe máy.", "Hruê mdei, kâo hiu chưn hồng bằng gặp. - Ngày nghỉ, tôi đi chơi với bạn."] }
            ], []);

            // Function to display a modal message
            const showMessage = (msg) => {
                setMessage(msg);
            };

            // Function to close the modal message
            const closeMessage = () => {
                setMessage('');
            };

            // --- Firebase Initialization and Authentication ---
            useEffect(() => {
                const initializeFirebase = async () => {
                    try {
                        // Retrieve Firebase config and app ID from global variables provided by the environment
                        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                        if (!firebaseConfig) {
                            console.error("Firebase config is not available.");
                            setAuthLoading(false);
                            return;
                        }

                        // Initialize Firebase app, Auth, and Firestore instances
                        const app = window.firebase.initializeApp(firebaseConfig);
                        const authInstance = window.firebase.getAuth(app);
                        const firestoreInstance = window.firebase.getFirestore(app);

                        setDb(firestoreInstance); // Set Firestore instance to state
                        setAuth(authInstance); // Set Auth instance to state

                        // Listen for authentication state changes
                        window.firebase.onAuthStateChanged(authInstance, async (user) => {
                            if (user) {
                                // User is signed in
                                setUserId(user.uid);
                                setIsAuthenticated(true);
                            } else {
                                // User is signed out, attempt anonymous or custom token sign-in
                                try {
                                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                        // Sign in with custom token if available
                                        await window.firebase.signInWithCustomToken(authInstance, __initial_auth_token);
                                    } else {
                                        // Fallback to anonymous sign-in
                                        await window.firebase.signInAnonymously(authInstance);
                                    }
                                } catch (error) {
                                    console.error("Firebase sign-in error:", error);
                                    showMessage("Lỗi đăng nhập: " + error.message);
                                }
                            }
                            setAuthLoading(false); // Authentication process completed
                        });
                    } catch (error) {
                        console.error("Error initializing Firebase:", error);
                        showMessage("Lỗi khởi tạo Firebase: " + error.message);
                        setAuthLoading(false);
                    }
                };
                initializeFirebase();
            }, []); // Empty dependency array means this effect runs once on mount

            // --- Dark Mode Toggle ---
            useEffect(() => {
                // Add or remove 'dark' class from the document element based on darkMode state
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]); // Rerun when darkMode state changes

            const toggleDarkMode = () => {
                setDarkMode(!darkMode);
            };

            // SVG paths for sun and moon icons (for dark mode toggle)
            const sunIconPath = (
                <path fillRule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .75 0l.75.22a.75.75 0 0 1 .58.56l.006.048c.03.111.115.196.226.226l.048.006a.75.75 0 0 1 .56.58l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.58.56l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.75-.22a.75.75 0 0 1-.58-.56l-.006-.048a.75.75 0 0 1-.226-.226l-.048-.006a.75.75 0 0 1-.56-.58l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .58-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM12 6a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 12 6ZM12 15a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 12 15ZM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6ZM3.75 12a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75ZM18 12a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75ZM12 18.75a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75ZM5.625 4.5a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM18.375 4.5a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM5.625 18.75a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM18.375 18.75a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22Z" clipRule="evenodd" />
            );

            const moonIconPath = (
                <path d="M9.528 1.718a.75.75 0 0 1 .75 0l.75.22a.75.75 0 0 1 .58.56l.006.048c.03.111.115.196.226.226l.048.006a.75.75 0 0 1 .56.58l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.58.56l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.75-.22a.75.75 0 0 1-.58-.56l-.006-.048a.75.75 0 0 1-.226-.226l-.048-.006a.75.75 0 0 1-.56-.58l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .58-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM12 6a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 12 6ZM12 15a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5A.75.75 0 0 1 12 15ZM12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6ZM3.75 12a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75ZM18 12a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5h-1.5a.75.75 0 0 1-.75-.75ZM12 18.75a.75.75 0 0 1 .75.75v1.5a.75.75 0 0 1-1.5 0v-1.5a.75.75 0 0 1 .75-.75ZM5.625 4.5a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM18.375 4.5a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM5.625 18.75a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22ZM18.375 18.75a.75.75 0 0 1 .56-.56l.75-.22a.75.75 0 0 1 .75 0l.22.75a.75.75 0 0 1 0 .75l-.22.75a.75.75 0 0 1-.56.58l-.048.006a.75.75 0 0 1-.226.226l-.006.048a.75.75 0 0 1-.56.58l-.75.22a.75.75 0 0 1-.75 0l-.22-.75a.75.75 0 0 1 0-.75l.22-.75a.75.75 0 0 1 .56-.56l.048-.006a.75.75 0 0 1 .226-.226l.006-.048a.75.75 0 0 1 .56-.58l.75-.22Z" />
            );

            // --- Reset states when changing tabs ---
            // This ensures a clean slate when switching between different functionalities.
            useEffect(() => {
                setEdeWord('');
                setVietnameseMeaning('');
                setIsLoadingTextTranslate(false);
                setShowGenerateExampleButton(false);
                setExampleSentence('');
                setIsLoadingExample(false);
                setTranslationDirection('edeToViet'); // Reset translation direction to default

                setImageSrc(null);
                setImageFile(null); // Clear image file
                setExtractedText('');
                setImageTranslation('');
                setIsLoadingImageTranslate(false);

                setParagraphPrompt('');
                setGeneratedParagraph('');
                setIsLoadingParagraph(false);

                setExplanationWord('');
                setGeneratedExplanation('');
                setIsLoadingExplanation(false);

                setSpeechRecognitionText('');
                setIsRecording(false);
                if (recognitionRef.current) {
                    recognitionRef.current.stop(); // Stop any ongoing speech recognition
                }

                setSpeechSynthesisText('');
                setIsSpeaking(false);
                if (synthRef.current) {
                    synthRef.current.cancel(); // Stop any ongoing speech synthesis
                }
                setSelectedVoice(null); // Reset selected voice

                setMessage(''); // Clear any modal messages
            }, [activeTab]); // Effect runs whenever activeTab changes


            // --- Text Translation Logic ---
            const handleInputChange = (event) => {
                const input = event.target.value;
                setEdeWord(input); // Update input word state
                setExampleSentence(''); // Clear example when input changes
                setShowGenerateExampleButton(false); // Hide example button
                if (input.trim() === '') {
                    setVietnameseMeaning(''); // Clear meaning if input is empty
                } else {
                    translateWord(input, translationDirection); // Trigger translation
                }
            };

            const translateWord = async (word, direction) => {
                const lowerCaseWord = word.trim().toLowerCase();
                let foundEntry = null;
                let translatedText = '';
                let prompt = '';

                setIsLoadingTextTranslate(true);
                setVietnameseMeaning('Đang tìm kiếm bản dịch...');
                setExampleSentence('');
                setShowGenerateExampleButton(false);

                try {
                    if (direction === 'edeToViet') {
                        // Search in internal dictionary (Êđê to Việt)
                        foundEntry = dictionaryData.find(entry => entry.ede.toLowerCase() === lowerCaseWord);
                        if (foundEntry) {
                            translatedText = `(${foundEntry.type}) ${foundEntry.vietnamese} (Từ điển nội bộ)`;
                            if (foundEntry.examples && foundEntry.examples.length > 0) {
                                setExampleSentence(foundEntry.examples.join('\n'));
                            } else {
                                setExampleSentence('Không có ví dụ trong từ điển.');
                                setShowGenerateExampleButton(true); // Allow AI example generation
                            }
                        } else {
                            // If not found in dictionary, prepare prompt for AI translation
                            prompt = `Dịch từ Êđê sau sang tiếng Việt: "${word}". Chỉ trả về bản dịch thuần túy, không có giải thích hay định dạng gì thêm. Nếu không biết, hãy trả lời "Không tìm thấy".`;
                        }
                    } else { // direction === 'vietToEde'
                        // Search in internal dictionary (Việt to Êđê)
                        foundEntry = dictionaryData.find(entry => entry.vietnamese.toLowerCase().includes(lowerCaseWord));
                        if (foundEntry) {
                            translatedText = `${foundEntry.ede} (Từ điển nội bộ)`;
                            if (foundEntry.examples && foundEntry.examples.length > 0) {
                                setExampleSentence(foundEntry.examples.join('\n'));
                            } else {
                                setExampleSentence('Không có ví dụ trong từ điển.');
                                setShowGenerateExampleButton(true); // Allow AI example generation
                            }
                        } else {
                            // If not found in dictionary, prepare prompt for AI translation
                            prompt = `Dịch từ tiếng Việt sau sang tiếng Êđê: "${word}". Chỉ trả về bản dịch thuần túy, không có giải thích hay định dạng gì thêm. Nếu không biết, hãy trả lời "Không tìm thấy".`;
                        }
                    }

                    if (foundEntry) {
                        setVietnameseMeaning(translatedText);
                        // Show example button if it's an Ede-to-Viet translation or if the dictionary entry had no examples
                        setShowGenerateExampleButton(direction === 'edeToViet' || (foundEntry.examples && foundEntry.examples.length === 0));
                    } else {
                        // Use AI for translation if not found in dictionary
                        let chatHistory = [];
                        chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                        const payload = { contents: chatHistory };
                        const apiKey = ""; // API key is automatically provided by the Canvas environment
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        // Handle API response
                        if (!response.ok) {
                            const errorDetails = response.statusText || `Lỗi không xác định (Mã: ${response.status})`;
                            if (response.status === 403) {
                                throw new Error(`Lỗi API: Quyền truy cập bị từ chối (Mã: 403). Vui lòng kiểm tra cấu hình API key.`);
                            }
                            throw new Error(`Lỗi API dịch văn bản: ${errorDetails}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            if (text.toLowerCase().includes("không tìm thấy")) {
                                setVietnameseMeaning(`Không tìm thấy từ này trong từ điển hoặc qua AI.`);
                                setShowGenerateExampleButton(false);
                            } else {
                                setVietnameseMeaning(`${text} (Dịch bởi AI)`);
                                // Only show example button if original input was Ede and translated by AI
                                setShowGenerateExampleButton(direction === 'edeToViet');
                            }
                        } else {
                            setVietnameseMeaning("Không thể dịch từ này bằng AI.");
                            setShowGenerateExampleButton(false);
                        }
                    }
                } catch (error) {
                    console.error("Lỗi khi dịch:", error);
                    showMessage("Đã xảy ra lỗi khi dịch từ: " + error.message);
                    setVietnameseMeaning("Đã xảy ra lỗi khi dịch từ.");
                    setShowGenerateExampleButton(false);
                } finally {
                    setIsLoadingTextTranslate(false); // Hide loading indicator
                }
            };

            // Function to generate an example sentence using AI
            const generateExampleSentence = async () => {
                if (!edeWord.trim()) {
                    showMessage("Vui lòng nhập từ tiếng Êđê để tạo ví dụ.");
                    return;
                }
                // This function is specifically for Ede examples, so it always uses edeWord as Ede input
                setIsLoadingExample(true);
                setExampleSentence('Đang tạo ví dụ...');
                try {
                    const prompt = `Tạo một câu ví dụ bằng tiếng Êđê sử dụng từ: "${edeWord}". Sau đó dịch câu đó sang tiếng Việt. Định dạng: "Câu Êđê - Câu Việt".`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key is automatically provided by the Canvas environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Handle API response
                    if (!response.ok) {
                        const errorDetails = response.statusText || `Lỗi không xác định (Mã: ${response.status})`;
                        if (response.status === 403) {
                            throw new Error(`Lỗi API: Quyền truy cập bị từ chối (Mã: 403). Vui lòng kiểm tra cấu hình API key.`);
                        }
                        throw new Error(`Lỗi API tạo ví dụ: ${errorDetails}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const text = result.candidates[0].content.parts[0].text;
                        setExampleSentence(text);
                    } else {
                        setExampleSentence("Không thể tạo ví dụ.");
                    }
                } catch (error) {
                    console.error("Lỗi khi tạo ví dụ:", error);
                    showMessage("Đã xảy ra lỗi khi tạo ví dụ: " + error.message);
                    setExampleSentence("Đã xảy ra lỗi khi tạo ví dụ.");
                } finally {
                    setIsLoadingExample(false); // Hide loading indicator
                }
            };

            // Function to toggle translation direction
            const toggleTranslationDirection = () => {
                setTranslationDirection(prevDirection => {
                    const newDirection = prevDirection === 'edeToViet' ? 'vietToEde' : 'edeToViet';
                    // Clear current translation results when direction changes
                    setEdeWord('');
                    setVietnameseMeaning('');
                    setExampleSentence('');
                    setShowGenerateExampleButton(false);
                    return newDirection;
                });
            };

            // --- Image Translation Logic ---
            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    setImageFile(file); // Store the file object to get its MIME type later
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        setImageSrc(e.target.result); // Set image source for display
                        setExtractedText(''); // Clear previous extracted text
                        setImageTranslation(''); // Clear previous translation
                    };
                    reader.readAsDataURL(file); // Read file as Data URL (base64)
                }
            };

            const handleImageTranslate = async () => {
                if (!imageSrc || !imageFile) {
                    showMessage("Vui lòng chọn một hình ảnh trước.");
                    return;
                }
                setIsLoadingImageTranslate(true);
                setExtractedText('');
                setImageTranslation('');

                try {
                    const base64ImageData = imageSrc.split(',')[1]; // Extract base64 data
                    const mimeType = imageFile.type; // Get MIME type from the file object

                    // Step 1: Extract text from image using AI
                    const extractPrompt = "Trích xuất tất cả văn bản tiếng Êđê từ hình ảnh này. Chỉ trả về văn bản thuần túy, không có giải thích hay định dạng gì thêm.";
                    let chatHistoryExtract = [];
                    chatHistoryExtract.push({ role: "user", parts: [{ text: extractPrompt }] });
                    chatHistoryExtract.push({ role: "user", parts: [{ inline_data: { mime_type: mimeType, data: base64ImageData } }] });

                    const payloadExtract = { contents: chatHistoryExtract };
                    const apiKey = ""; // API key is automatically provided by the Canvas environment
                    const apiUrlExtract = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    
                    const responseExtract = await fetch(apiUrlExtract, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payloadExtract)
                    });

                    // Handle API response for text extraction
                    if (!responseExtract.ok) {
                        const errorDetails = responseExtract.statusText || `Lỗi không xác định (Mã: ${responseExtract.status})`;
                        if (responseExtract.status === 403) {
                            throw new Error(`Lỗi API: Quyền truy cập bị từ chối (Mã: 403). Vui lòng kiểm tra cấu hình API key.`);
                        }
                        throw new Error(`Lỗi API trích xuất văn bản: ${errorDetails}`);
                    }

                    const resultExtract = await responseExtract.json();
                    let extractedTextFromImage = "Không thể trích xuất văn bản.";
                    if (resultExtract.candidates && resultExtract.candidates[0]?.content?.parts[0]?.text) {
                        extractedTextFromImage = resultExtract.candidates[0].content.parts[0].text;
                    }
                    setExtractedText(extractedTextFromImage);

                    // Step 2: Translate extracted text if successful
                    if (extractedTextFromImage && extractedTextFromImage.trim() !== "" && extractedTextFromImage !== "Không thể trích xuất văn bản.") {
                        const translatePrompt = `Dịch đoạn văn tiếng Êđê sau sang tiếng Việt: "${extractedTextFromImage}". Chỉ trả về bản dịch thuần túy, không có giải thích hay định dạng gì thêm.`;
                        let chatHistoryTranslate = [];
                        chatHistoryTranslate.push({ role: "user", parts: [{ text: translatePrompt }] });
                        const payloadTranslate = { contents: chatHistoryTranslate };
                        const apiUrlTranslate = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                        const responseTranslate = await fetch(apiUrlTranslate, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payloadTranslate)
                        });

                        // Handle API response for translation
                        if (!responseTranslate.ok) {
                            const errorDetails = responseTranslate.statusText || `Lỗi không xác định (Mã: ${responseTranslate.status})`;
                            if (responseTranslate.status === 403) {
                                throw new Error(`Lỗi API: Quyền truy cập bị từ chối (Mã: 403). Vui lòng kiểm tra cấu hình API key.`);
                            }
                            throw new Error(`Lỗi API dịch văn bản: ${errorDetails}`);
                        }

                        const resultTranslate = await responseTranslate.json();
                        let translatedText = "Không thể dịch văn bản.";
                        if (resultTranslate.candidates && resultTranslate.candidates[0]?.content?.parts[0]?.text) {
                            translatedText = resultTranslate.candidates[0].content.parts[0].text;
                        }
                        setImageTranslation(translatedText);
                    } else {
                        setImageTranslation("Không có văn bản để dịch.");
                    }

                } catch (error) {
                    console.error("Lỗi khi dịch ảnh:", error);
                    showMessage(`Đã xảy ra lỗi: ${error.message}. Vui lòng thử lại.`);
                    setExtractedText("Đã xảy ra lỗi khi trích xuất văn bản từ ảnh.");
                    setImageTranslation("Đã xảy ra lỗi khi dịch văn bản từ ảnh.");
                } finally {
                    setIsLoadingImageTranslate(false); // Hide loading indicator
                }
            };

            // --- Paragraph Generation Logic ---
            const generateParagraph = async () => {
                if (!paragraphPrompt.trim()) {
                    showMessage("Vui lòng nhập chủ đề để tạo đoạn văn.");
                    return;
                }
                setIsLoadingParagraph(true);
                setGeneratedParagraph('Đang tạo đoạn văn...'); // Set loading message
                try {
                    const prompt = `Viết một đoạn văn ngắn bằng tiếng Êđê về chủ đề: "${paragraphPrompt}". Độ dài khoảng 3-5 câu. Đảm bảo ngữ pháp và từ vựng chính xác.`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key is automatically provided by the Canvas environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Handle API response
                    if (!response.ok) {
                        const errorDetails = response.statusText || `Lỗi không xác định (Mã: ${response.status})`;
                        if (response.status === 403) {
                            throw new Error(`Lỗi API: Quyền truy cập bị từ chối (Mã: 403). Vui lòng kiểm tra cấu hình API key.`);
                        }
                        throw new Error(`Lỗi API tạo đoạn văn: ${errorDetails}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        setGeneratedParagraph(result.candidates[0].content.parts[0].text);
                    } else {
                        console.error("API response missing expected content structure:", result);
                        setGeneratedParagraph("Không thể tạo đoạn văn: Phản hồi API không có nội dung mong muốn.");
                    }
                } catch (error) {
                    console.error("Lỗi khi tạo đoạn văn:", error);
                    showMessage(`Đã xảy ra lỗi khi tạo đoạn văn: ${error.message}. Vui lòng thử lại.`);
                    setGeneratedParagraph(`Đã xảy ra lỗi khi tạo đoạn văn: ${error.message}.`);
                } finally {
                    setIsLoadingParagraph(false); // Hide loading indicator
                }
            };

            // Function to save generated paragraph to Firebase history
            const saveParagraphToHistory = async () => {
                if (!isAuthenticated || !userId || !db) {
                    showMessage("Vui lòng đăng nhập để lưu lịch sử.");
                    return;
                }
                if (!paragraphPrompt.trim() || !generatedParagraph.trim()) {
                    showMessage("Không có đoạn văn để lưu.");
                    return;
                }
                try {
                    // Use __app_id for the collection path as required
                    const historyCollectionRef = window.firebase.collection(db, `artifacts/${__app_id}/users/${userId}/ede_history`);
                    await window.firebase.addDoc(historyCollectionRef, {
                        type: 'paragraph_generation',
                        prompt: paragraphPrompt,
                        edeText: generatedParagraph,
                        timestamp: window.firebase.serverTimestamp() // Use server timestamp for consistent ordering
                    });
                    showMessage("Đoạn văn đã được lưu vào lịch sử!");
                } catch (error) {
                    console.error("Lỗi khi lưu đoạn văn:", error);
                    showMessage("Lỗi khi lưu đoạn văn: " + error.message);
                }
            };

            // --- Explanation Logic ---
            const getExplanation = async () => {
                if (!explanationWord.trim()) {
                    showMessage("Vui lòng nhập từ hoặc khái niệm để giải thích.");
                    return;
                }
                setIsLoadingExplanation(true);
                setGeneratedExplanation('Đang giải thích...'); // Set loading message
                try {
                    const prompt = `Giải thích khái niệm/từ Êđê sau bằng tiếng Việt: "${explanationWord}". Trả lời ngắn gọn, rõ ràng, không quá 3 câu.`;
                    let chatHistory = [];
                    chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                    const payload = { contents: chatHistory };
                    const apiKey = ""; // API key is automatically provided by the Canvas environment
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    // Handle API response
                    if (!response.ok) {
                        const errorDetails = response.statusText || `Lỗi không xác định (Mã: ${response.status})`;
                        if (response.status === 403) {
                            throw new Error(`Lỗi API: Quyền truy cập bị từ chối (Mã: 403). Vui lòng kiểm tra cấu hình API key.`);
                        }
                        throw new Error(`Lỗi API giải thích: ${errorDetails}`);
                    }

                    const result = await response.json();
                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        setGeneratedExplanation(result.candidates[0].content.parts[0].text);
                    } else {
                        setGeneratedExplanation("Không thể giải thích khái niệm này.");
                    }
                } catch (error) {
                    console.error("Lỗi khi giải thích:", error);
                    showMessage("Đã xảy ra lỗi khi giải thích: " + error.message);
                    setGeneratedExplanation("Đã xảy ra lỗi khi giải thích.");
                } finally {
                    setIsLoadingExplanation(false); // Hide loading indicator
                }
            };

            // Function to save generated explanation to Firebase history
            const saveExplanationToHistory = async () => {
                if (!isAuthenticated || !userId || !db) {
                    showMessage("Vui lòng đăng nhập để lưu lịch sử.");
                    return;
                }
                if (!explanationWord.trim() || !generatedExplanation.trim()) {
                    showMessage("Không có giải thích để lưu.");
                    return;
                }
                try {
                    // Use __app_id for the collection path as required
                    const historyCollectionRef = window.firebase.collection(db, `artifacts/${__app_id}/users/${userId}/ede_history`);
                    await window.firebase.addDoc(historyCollectionRef, {
                        type: 'explanation',
                        word: explanationWord,
                        explanationText: generatedExplanation,
                        timestamp: window.firebase.serverTimestamp() // Use server timestamp for consistent ordering
                    });
                    showMessage("Giải thích đã được lưu vào lịch sử!");
                } catch (error) {
                    console.error("Lỗi khi lưu giải thích:", error);
                    showMessage("Lỗi khi lưu giải thích: " + error.message);
                }
            };

            // --- Speech-to-Text Logic ---
            useEffect(() => {
                // Check if browser supports SpeechRecognition API
                if (!('webkitSpeechRecognition' in window)) {
                    showMessage("Trình duyệt của bạn không hỗ trợ nhận dạng giọng nói. Vui lòng sử dụng Chrome hoặc trình duyệt tương thích.");
                    return;
                }

                const SpeechRecognition = window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.continuous = false; // Set to true for continuous recognition
                recognition.interimResults = true; // Get interim results for live feedback
                recognition.lang = 'vi-VN'; // Set language to Vietnamese

                // Event handlers for speech recognition
                recognition.onstart = () => {
                    setIsRecording(true);
                    setSpeechRecognitionText('Đang nghe...');
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript;
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    setSpeechRecognitionText(finalTranscript || interimTranscript); // Display final or interim text
                };

                recognition.onerror = (event) => {
                    setIsRecording(false);
                    console.error("Speech recognition error:", event.error);
                    setSpeechRecognitionText(`Lỗi: ${event.error}. Vui lòng thử lại.`);
                    showMessage(`Lỗi nhận dạng giọng nói: ${event.error}. Vui lòng kiểm tra micro và cấp quyền.`);
                };

                recognition.onend = () => {
                    setIsRecording(false);
                    if (speechRecognitionText === 'Đang nghe...') {
                        setSpeechRecognitionText('Không nhận dạng được giọng nói. Vui lòng thử lại.');
                    }
                };

                recognitionRef.current = recognition; // Store recognition object in ref

                // Cleanup function to stop recognition if component unmounts
                return () => {
                    if (recognitionRef.current) {
                        recognitionRef.current.stop();
                    }
                };
            }, []); // Empty dependency array means this effect runs once on mount

            const startSpeechRecognition = () => {
                if (recognitionRef.current) {
                    setSpeechRecognitionText(''); // Clear previous text
                    recognitionRef.current.start(); // Start recognition
                }
            };

            const stopSpeechRecognition = () => {
                if (recognitionRef.current) {
                    recognitionRef.current.stop(); // Stop recognition
                }
            };

            // --- Text-to-Speech Logic ---
            useEffect(() => {
                // Check if browser supports SpeechSynthesis API
                if (!('speechSynthesis' in window)) {
                    showMessage("Trình duyệt của bạn không hỗ trợ chuyển văn bản thành giọng nói.");
                    return;
                }

                const synth = window.speechSynthesis;
                synthRef.current = synth; // Store synth object in ref

                const loadVoices = () => {
                    const availableVoices = synth.getVoices();
                    setVoices(availableVoices); // Set available voices
                    // Try to select a Vietnamese voice by default
                    const defaultVietnameseVoice = availableVoices.find(voice => voice.lang === 'vi-VN');
                    if (defaultVietnameseVoice) {
                        setSelectedVoice(defaultVietnameseVoice);
                    } else if (availableVoices.length > 0) {
                        // Fallback to first available voice if no Vietnamese voice is found
                        setSelectedVoice(availableVoices[0]);
                    }
                };

                // Load voices when they change (e.g., after page load or new voices are installed)
                synth.onvoiceschanged = loadVoices;
                // Load voices immediately if they are already available (for cases where onvoiceschanged might not fire)
                if (synth.getVoices().length > 0) {
                    loadVoices();
                }

                // Cleanup function to cancel any ongoing speech if component unmounts
                return () => {
                    if (synthRef.current) {
                        synthRef.current.cancel();
                    }
                };
            }, []); // Empty dependency array means this effect runs once on mount

            const speakText = () => {
                if (!speechSynthesisText.trim()) {
                    showMessage("Vui lòng nhập văn bản để đọc.");
                    return;
                }
                if (!synthRef.current) {
                    showMessage("Chức năng chuyển văn bản thành giọng nói không khả dụng.");
                    return;
                }
                
                if (synthRef.current.speaking) {
                    synthRef.current.cancel(); // Stop current speech if any is ongoing
                }

                const utterance = new SpeechSynthesisUtterance(speechSynthesisText);
                if (selectedVoice) {
                    utterance.voice = selectedVoice; // Use selected voice
                } else {
                    utterance.lang = 'vi-VN'; // Fallback to Vietnamese language if no specific voice is selected
                }

                // Event handlers for speech synthesis
                utterance.onstart = () => setIsSpeaking(true);
                utterance.onend = () => setIsSpeaking(false);
                utterance.onerror = (event) => {
                    setIsSpeaking(false);
                    console.error("Speech synthesis error:", event.error);
                    showMessage(`Lỗi chuyển văn bản thành giọng nói: ${event.error}`);
                };

                synthRef.current.speak(utterance); // Start speaking
            };

            const stopSpeaking = () => {
                if (synthRef.current && synthRef.current.speaking) {
                    synthRef.current.cancel(); // Cancel current speech
                    setIsSpeaking(false);
                }
            };

            // --- History Logic ---
            useEffect(() => {
                // Fetch history only if authenticated, Firebase is initialized, and on the 'history' tab
                if (db && userId && isAuthenticated && activeTab === 'history') {
                    if (historyUnsubscribeRef.current) {
                        historyUnsubscribeRef.current(); // Unsubscribe from previous listener to avoid duplicates
                    }
                    // Define the Firestore collection path using __app_id
                    const historyCollectionRef = window.firebase.collection(db, `artifacts/${__app_id}/users/${userId}/ede_history`);
                    // Create a query without orderBy to avoid index issues, sorting will be done in memory
                    const q = window.firebase.query(historyCollectionRef);
                    
                    // Set up a real-time listener for the history collection
                    historyUnsubscribeRef.current = window.firebase.onSnapshot(q, (snapshot) => {
                        const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        // Sort items by timestamp in descending order (newest first) in memory
                        const sortedItems = items.sort((a, b) => {
                            const dateA = a.timestamp?.toDate ? a.timestamp.toDate() : new Date(a.timestamp);
                            const dateB = b.timestamp?.toDate ? b.timestamp.toDate() : new Date(b.timestamp);
                            return dateB - dateA;
                        });
                        setHistoryItems(sortedItems);
                    }, (error) => {
                        console.error("Error fetching history:", error);
                        showMessage("Lỗi khi tải lịch sử: " + error.message);
                    });
                } else if (historyUnsubscribeRef.current) {
                    // Unsubscribe and clear history if not authenticated or not on history tab
                    historyUnsubscribeRef.current();
                    historyUnsubscribeRef.current = null;
                    setHistoryItems([]);
                }
                // Cleanup function for the effect
                return () => {
                    if (historyUnsubscribeRef.current) {
                        historyUnsubscribeRef.current();
                    }
                };
            }, [db, userId, isAuthenticated, activeTab]); // Dependencies for this effect

            // Helper function to format Firebase Timestamps
            const formatTimestamp = (timestamp) => {
                if (!timestamp) return 'N/A';
                // Convert Firebase Timestamp object to Date object if needed, then format
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString('vi-VN'); // Format date to Vietnamese locale string
            };

            // Show loading spinner while Firebase is initializing
            if (authLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-800">
                        <div className="loader"></div>
                        <p className="ml-4 text-gray-700 dark:text-gray-300">Đang tải ứng dụng...</p>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 dark:bg-gray-800 flex flex-col items-center p-4 transition-colors duration-300">
                    <div className="w-full max-w-3xl mx-auto space-y-8">
                        
                        {/* Header and Dark Mode Toggle */}
                        <div className="flex justify-between items-center mb-6">
                            <div className="text-center flex-grow">
                                <h1 className="text-4xl md:text-5xl font-extrabold text-gray-800 dark:text-white mb-2">
                                    <span className="text-indigo-600 dark:text-indigo-400">Từ điển</span> & <span className="text-purple-600 dark:text-purple-400">Dịch thuật Êđê</span>
                                </h1>
                                <p className="text-lg text-gray-600 dark:text-gray-300">Dịch từ, cụm từ và hình ảnh; tạo văn bản và giải thích.</p>
                            </div>
                            <button
                                onClick={toggleDarkMode}
                                className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 shadow-md hover:shadow-lg transition-all"
                                aria-label="Toggle dark mode"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className="w-6 h-6">
                                    {darkMode ? sunIconPath : moonIconPath}
                                </svg>
                            </button>
                        </div>

                        {/* Navigation Tabs */}
                        <div className="flex justify-center border-b border-gray-200 dark:border-gray-700 mb-8 overflow-x-auto">
                            <TabButton tabName="translate" activeTab={activeTab} setActiveTab={setActiveTab}>Dịch Văn Bản</TabButton>
                            <TabButton tabName="image" activeTab={activeTab} setActiveTab={setActiveTab}>Dịch Từ Ảnh</TabButton>
                            <TabButton tabName="generate" activeTab={activeTab} setActiveTab={setActiveTab}>Tạo Đoạn Văn</TabButton>
                            <TabButton tabName="explain" activeTab={activeTab} setActiveTab={setActiveTab}>Giải Thích</TabButton>
                            <TabButton tabName="speechToText" activeTab={activeTab} setActiveTab={setActiveTab}>Giọng nói thành Văn bản</TabButton>
                            <TabButton tabName="textToSpeech" activeTab={activeTab} setActiveTab={setActiveTab}>Văn bản thành Giọng nói</TabButton>
                            <TabButton tabName="history" activeTab={activeTab} setActiveTab={setActiveTab} disabled={!isAuthenticated}>Lịch Sử</TabButton>
                        </div>

                        {/* Tab Content - Conditional Rendering based on activeTab */}
                        {activeTab === 'translate' && (
                            <div className="bg-white dark:bg-gray-700 p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Dịch văn bản</h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">
                                    Nhập một từ hoặc cụm từ để nhận bản dịch và ví dụ (nếu có).
                                </p>
                                <div className="space-y-4">
                                    <div className="flex justify-center mb-4">
                                        <button
                                            onClick={toggleTranslationDirection}
                                            className="px-6 py-2 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition-colors flex items-center space-x-2"
                                        >
                                            <span>
                                                {translationDirection === 'edeToViet' ? 'Êđê → Việt' : 'Việt → Êđê'}
                                            </span>
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={2} stroke="currentColor" className="w-5 h-5">
                                                <path strokeLinecap="round" strokeLinejoin="round" d="M7.5 21 3 16.5m0 0L7.5 12M3 16.5h13.5m0-13.5L21 7.5m0 0L16.5 12M21 7.5H7.5" />
                                            </svg>
                                        </button>
                                    </div>
                                    <div>
                                        <label htmlFor="edeInput" className="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                                            {translationDirection === 'edeToViet' ? 'Nhập từ tiếng Êđê:' : 'Nhập từ tiếng Việt:'}
                                        </label>
                                        <input
                                            type="text"
                                            id="edeInput"
                                            className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-lg bg-gray-50 dark:bg-gray-800"
                                            placeholder={translationDirection === 'edeToViet' ? 'Ví dụ: Kâo, Sang, Mă bruă...' : 'Ví dụ: Tôi, Nhà, Làm việc...'}
                                            value={edeWord}
                                            onChange={handleInputChange}
                                        />
                                    </div>
                                    <div className="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg border border-indigo-200 dark:border-indigo-700 min-h-[90px] flex flex-col justify-center">
                                        <h3 className="text-md font-semibold text-indigo-800 dark:text-indigo-200 mb-1">
                                            {translationDirection === 'edeToViet' ? 'Nghĩa tiếng Việt:' : 'Nghĩa tiếng Êđê:'}
                                        </h3>
                                        {isLoadingTextTranslate ? (
                                            <div className="loader mx-auto my-4"></div>
                                        ) : (
                                            <p className="text-gray-800 dark:text-gray-100 text-base">
                                                {vietnameseMeaning || "Kết quả sẽ hiển thị ở đây."}
                                            </p>
                                        )}
                                    </div>
                                    <div className="bg-blue-50 dark:bg-blue-900 p-4 rounded-lg border border-blue-200 dark:border-blue-700 min-h-[90px] flex flex-col justify-center">
                                        <h3 className="text-md font-semibold text-blue-700 dark:text-blue-200 mb-1">Ví dụ:</h3>
                                        {isLoadingExample ? (
                                            <div className="loader mx-auto my-4"></div>
                                        ) : (
                                            <p className="text-gray-800 dark:text-gray-100 text-base whitespace-pre-wrap">
                                                {exampleSentence || "Ví dụ về cách sử dụng từ sẽ hiển thị ở đây."}
                                            </p>
                                        )}
                                        {showGenerateExampleButton && !isLoadingExample && translationDirection === 'edeToViet' && (
                                            <button
                                                onClick={generateExampleSentence}
                                                className="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors self-start"
                                            >
                                                Tạo ví dụ bằng AI
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'image' && (
                            <div className="bg-white dark:bg-gray-700 p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Dịch từ ảnh</h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">Tải lên một hình ảnh chứa văn bản tiếng Êđê để trích xuất và dịch.</p>
                                <div className="space-y-4">
                                    <div className="p-4 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-center bg-gray-50 dark:bg-gray-800">
                                        <label htmlFor="imageUpload" className="cursor-pointer inline-flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 transition-colors">
                                            Chọn ảnh
                                        </label>
                                        <input id="imageUpload" type="file" accept="image/jpeg,image/png,image/gif" className="hidden" onChange={handleImageUpload} />
                                        <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">PNG, JPG, GIF,...</p>
                                    </div>

                                    {imageSrc && (
                                        <div className="mt-4 text-center">
                                            <img src={imageSrc} alt="Ảnh đã tải lên" className="max-w-full max-h-60 mx-auto rounded-lg shadow-md" />
                                        </div>
                                    )}
                                    
                                    <button
                                        onClick={handleImageTranslate}
                                        disabled={isLoadingImageTranslate || !imageSrc}
                                        className="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                    >
                                        {isLoadingImageTranslate ? <div className="loader"></div> : 'Trích xuất & Dịch từ ảnh'}
                                    </button>

                                    {(extractedText || imageTranslation || isLoadingImageTranslate) && (
                                        <div className="mt-4 space-y-4">
                                            <div className="bg-purple-50 dark:bg-purple-900 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                                                <h3 className="text-md font-semibold text-purple-800 dark:text-purple-200 mb-1">Văn bản gốc (Êđê):</h3>
                                                <p className="text-gray-800 dark:text-gray-100 text-base whitespace-pre-wrap">
                                                    {isLoadingImageTranslate && !extractedText ? "Đang trích xuất văn bản..." : extractedText}
                                                </p>
                                            </div>
                                            <div className="bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg border border-indigo-200 dark:border-indigo-700">
                                                <h3 className="text-md font-semibold text-indigo-800 dark:text-indigo-200 mb-1">Bản dịch (Việt):</h3>
                                                <p className="text-gray-800 dark:text-gray-100 text-base whitespace-pre-wrap">
                                                    {isLoadingImageTranslate && !imageTranslation ? "Đang dịch văn bản..." : imageTranslation}
                                                </p>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'generate' && (
                            <div className="bg-white dark:bg-gray-700 p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Tạo đoạn văn Êđê</h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">Nhập một chủ đề bằng tiếng Việt, AI sẽ giúp bạn tạo một đoạn văn ngắn bằng tiếng Êđê.</p>
                                <div className="space-y-4">
                                    <div>
                                        <label htmlFor="paragraphPrompt" className="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                                            Chủ đề (tiếng Việt):
                                        </label>
                                        <textarea
                                            id="paragraphPrompt"
                                            className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-lg bg-gray-50 dark:bg-gray-800 min-h-[100px]"
                                            placeholder="Ví dụ: Một ngày ở buôn làng, Lễ hội truyền thống Êđê..."
                                            value={paragraphPrompt}
                                            onChange={(e) => setParagraphPrompt(e.target.value)}
                                        ></textarea>
                                    </div>
                                    <button
                                        onClick={generateParagraph}
                                        disabled={isLoadingParagraph}
                                        className="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                    >
                                        {isLoadingParagraph ? <div className="loader"></div> : 'Tạo Đoạn Văn'}
                                    </button>
                                    {generatedParagraph && (
                                        <div className="mt-4 bg-indigo-50 dark:bg-indigo-900 p-4 rounded-lg border border-indigo-200 dark:border-indigo-700">
                                            <h3 className="text-md font-semibold text-indigo-800 dark:text-indigo-200 mb-1">Đoạn văn Êđê:</h3>
                                            <p className="text-gray-800 dark:text-gray-100 text-base whitespace-pre-wrap">{generatedParagraph}</p>
                                            {isAuthenticated && (
                                                <button
                                                    onClick={saveParagraphToHistory}
                                                    className="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                                                >
                                                    Lưu vào Lịch Sử
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'explain' && (
                            <div className="bg-white dark:bg-gray-700 p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Giải thích từ/khái niệm Êđê</h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">Nhập một từ hoặc khái niệm tiếng Êđê để nhận lời giải thích ngắn gọn bằng tiếng Việt.</p>
                                <div className="space-y-4">
                                    <div>
                                        <label htmlFor="explanationWord" className="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                                            Từ/Khái niệm (tiếng Êđê):
                                        </label>
                                        <input
                                            type="text"
                                            id="explanationWord"
                                            className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-lg bg-gray-50 dark:bg-gray-800"
                                            placeholder="Ví dụ: Klei, Buôn, Mnuih Êđê..."
                                            value={explanationWord}
                                            onChange={(e) => setExplanationWord(e.target.value)}
                                        />
                                    </div>
                                    <button
                                        onClick={getExplanation}
                                        disabled={isLoadingExplanation}
                                        className="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                    >
                                        {isLoadingExplanation ? <div className="loader"></div> : 'Giải Thích'}
                                    </button>
                                    {generatedExplanation && (
                                        <div className="mt-4 bg-purple-50 dark:bg-purple-900 p-4 rounded-lg border border-purple-200 dark:border-purple-700">
                                            <h3 className="text-md font-semibold text-purple-800 dark:text-purple-200 mb-1">Giải thích (tiếng Việt):</h3>
                                            <p className="text-gray-800 dark:text-gray-100 text-base whitespace-pre-wrap">{generatedExplanation}</p>
                                            {isAuthenticated && (
                                                <button
                                                    onClick={saveExplanationToHistory}
                                                    className="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors"
                                                >
                                                    Lưu vào Lịch Sử
                                                </button>
                                            )}
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'speechToText' && (
                            <div className="bg-white dark:bg-gray-700 p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Giọng nói thành Văn bản</h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">Nhấn "Bắt đầu ghi âm" để nói và chuyển giọng nói thành văn bản.</p>
                                <div className="space-y-4">
                                    <div className="flex justify-center space-x-4">
                                        <button
                                            onClick={startSpeechRecognition}
                                            disabled={isRecording}
                                            className="px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-green-600 hover:bg-green-700 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                        >
                                            {isRecording ? 'Đang ghi âm...' : 'Bắt đầu ghi âm'}
                                        </button>
                                        <button
                                            onClick={stopSpeechRecognition}
                                            disabled={!isRecording}
                                            className="px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                        >
                                            Dừng ghi âm
                                        </button>
                                    </div>
                                    <div className="mt-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-300 dark:border-gray-600 min-h-[100px]">
                                        <h3 className="text-md font-semibold text-gray-700 dark:text-gray-300 mb-1">Văn bản được nhận dạng:</h3>
                                        <p className="text-gray-800 dark:text-gray-100 text-base whitespace-pre-wrap">
                                            {speechRecognitionText || "Văn bản nhận dạng sẽ hiển thị ở đây."}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'textToSpeech' && (
                            <div className="bg-white dark:bg-gray-700 p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Văn bản thành Giọng nói</h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">Nhập văn bản và nghe ứng dụng đọc to.</p>
                                <div className="space-y-4">
                                    <div>
                                        <label htmlFor="speechSynthesisText" className="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                                            Văn bản muốn đọc:
                                        </label>
                                        <textarea
                                            id="speechSynthesisText"
                                            className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 dark:text-white placeholder-gray-400 dark:placeholder-gray-500 text-lg bg-gray-50 dark:bg-gray-800 min-h-[100px]"
                                            placeholder="Ví dụ: Kâo khăp hriăm klei Êđê. - Tôi thích học tiếng Êđê."
                                            value={speechSynthesisText}
                                            onChange={(e) => setSpeechSynthesisText(e.target.value)}
                                        ></textarea>
                                    </div>
                                    {voices.length > 0 && (
                                        <div>
                                            <label htmlFor="voiceSelect" className="block text-gray-700 dark:text-gray-300 text-sm font-semibold mb-2">
                                                Chọn giọng đọc:
                                            </label>
                                            <select
                                                id="voiceSelect"
                                                className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-200 ease-in-out text-gray-800 dark:text-white bg-gray-50 dark:bg-gray-800"
                                                value={selectedVoice ? selectedVoice.name : ''}
                                                onChange={(e) => setSelectedVoice(voices.find(voice => voice.name === e.target.value))}
                                            >
                                                {voices.map(voice => (
                                                    <option key={voice.name} value={voice.name}>
                                                        {voice.name} ({voice.lang}) {voice.default ? '(Mặc định)' : ''}
                                                    </option>
                                                ))}
                                            </select>
                                        </div>
                                    )}
                                    <div className="flex justify-center space-x-4">
                                        <button
                                            onClick={speakText}
                                            disabled={isSpeaking || !speechSynthesisText.trim()}
                                            className="px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                        >
                                            {isSpeaking ? 'Đang đọc...' : 'Đọc văn bản'}
                                        </button>
                                        <button
                                            onClick={stopSpeaking}
                                            disabled={!isSpeaking}
                                            className="px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-red-600 hover:bg-red-700 disabled:bg-gray-400 dark:disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors"
                                        >
                                            Dừng đọc
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'history' && (
                            <div className="bg-white dark:bg-gray-700 p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200 dark:border-gray-700 transition-all duration-300 hover:shadow-xl">
                                <h2 className="text-2xl font-bold text-gray-800 dark:text-white mb-4">Lịch sử tương tác</h2>
                                <p className="text-gray-600 dark:text-gray-400 mb-4">Xem lại các đoạn văn và giải thích bạn đã tạo.</p>
                                {!isAuthenticated ? (
                                    <p className="text-gray-500 dark:text-gray-400 text-center py-8">
                                        Vui lòng đăng nhập để xem lịch sử. Ứng dụng sẽ tự động đăng nhập ẩn danh khi khởi chạy.
                                    </p>
                                ) : historyItems.length === 0 ? (
                                    <p className="text-gray-500 dark:text-gray-400 text-center py-8">Chưa có mục nào trong lịch sử.</p>
                                ) : (
                                    <div className="space-y-4">
                                        {historyItems.map(item => (
                                            <div key={item.id} className="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                                                <p className="text-sm text-gray-500 dark:text-gray-400 mb-2">
                                                    {formatTimestamp(item.timestamp)} - Loại: {item.type === 'paragraph_generation' ? 'Tạo Đoạn Văn' : 'Giải Thích'}
                                                </p>
                                                {item.type === 'paragraph_generation' ? (
                                                    <>
                                                        <h4 className="font-semibold text-gray-700 dark:text-gray-300">Chủ đề: {item.prompt}</h4>
                                                        <p className="text-gray-800 dark:text-gray-100 whitespace-pre-wrap">{item.edeText}</p>
                                                    </>
                                                ) : (
                                                    <>
                                                        <h4 className="font-semibold text-gray-700 dark:text-gray-300">Từ/Khái niệm: {item.word}</h4>
                                                        <p className="text-gray-800 dark:text-gray-100 whitespace-pre-wrap">{item.explanationText}</p>
                                                    </>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                    {/* Message Modal */}
                    <MessageModal message={message} onClose={closeMessage} />
                </div>
            );
        }

        // TabButton Component for navigation tabs
        const TabButton = ({ tabName, activeTab, setActiveTab, children, disabled = false }) => (
            <button
                onClick={() => setActiveTab(tabName)}
                disabled={disabled}
                className={`px-4 py-2 text-lg font-medium rounded-t-lg transition-colors duration-200
                    ${activeTab === tabName
                        ? 'text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-500 dark:border-indigo-400'
                        : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 border-b-2 border-transparent hover:border-gray-300 dark:hover:border-gray-600'
                    }
                    ${disabled ? 'opacity-50 cursor-not-allowed' : ''}
                `}
            >
                {children}
            </button>
        );

        // Render the App component to the 'root' div in the HTML
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
